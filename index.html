<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Scanner - Vue Version</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Heebo", sans-serif;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.5s;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center p-4"
  >
    <div
      id="app"
      class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl w-full max-w-lg p-8 transition-all duration-300"
    >
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="text-6xl mb-4 animate-bounce">ğŸ›¡ï¸</div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">×¡×•×¨×§ ×•×™×“××• ×—×›×</h1>
        <p class="text-gray-500">×œ×©××•×¨ ×•×œ×”×¦×™×œ</p>
      </div>

      <!-- API Key Section -->
      <div class="mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >××¤×ª×— Gemini API</label
        >
        <div class="flex gap-2">
          <input
            type="password"
            v-model="apiKey"
            placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”××¤×ª×—..."
            class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
          />
          <button
            @click="saveApiKey"
            class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition-colors"
          >
            {{ savedMessage || '×©××•×¨' }}
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-1">
          ×”××¤×ª×— × ×©××¨ ×‘×“×¤×“×¤×Ÿ ×©×œ×š ×‘×œ×‘×“ (Local Storage)
        </p>
      </div>

      <!-- URL Input Section -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >×§×™×©×•×¨ ×œ-YouTube</label
        >
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xl"
            >ğŸ”—</span
          >
          <input
            type="text"
            v-model="videoUrl"
            @keyup.enter="scanVideo"
            placeholder="https://www.youtube.com/watch?v=..."
            class="w-full p-4 pl-12 border-2 border-gray-200 rounded-xl text-lg focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 outline-none transition-all"
          />
        </div>
      </div>

      <!-- Action Button -->
      <button
        @click="scanVideo"
        :disabled="loading || !videoUrl || !apiKey"
        class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transform transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        :class="loading ? 'bg-gray-400' : 'bg-emerald-500 hover:bg-emerald-600 hover:-translate-y-1'"
      >
        <span v-if="loading">ğŸ”„ ××¢×‘×“...</span>
        <span v-else>×¡×¨×•×§ ×•×™×“××•</span>
      </button>

      <!-- Error Message -->
      <div
        v-if="error"
        class="mt-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-center"
      >
        {{ error }}
      </div>

      <!-- Results -->
      <transition name="fade">
        <div v-if="result" class="mt-8 border-t pt-6">
          <div
            :class="['p-6 rounded-xl border-2 text-center', result.allowed ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200']"
          >
            <div class="text-4xl mb-2">{{ result.allowed ? 'âœ…' : 'â›”' }}</div>

            <h3
              class="text-xl font-bold mb-2"
              :class="result.allowed ? 'text-emerald-800' : 'text-red-800'"
            >
              {{ result.allowed ? '×œ× × ××¦××” ×‘×¢×™×”' : '× ××¦××” ×‘×¢×™×” ×‘×–××Ÿ: ' + result.timestamp }}
            </h3>

            <div class="text-sm opacity-80 mb-4">{{ result.details }}</div>

            <div class="mt-4 text-xs text-gray-400">
              Confidence: {{ result.confidence }}
            </div>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          const apiKey = ref("");
          const videoUrl = ref("");
          const loading = ref(false);
          const result = ref(null);
          const error = ref(null);
          const savedMessage = ref("");

          const PROMPT = `
ROLE: Strict Content Safety Moderator.
TASK: Analyze this video stream and determine if ANY REAL HUMAN FEMALE (woman or girl) appears whose apparent age is >= ~3 years.

RULES:
1. Ignore cartoons, animations, CGI, drawings, avatars, statues, reflections.
2. Evaluate only real live-action human presence.
3. Age threshold: Only count if she plausibly appears older than ~3 years.
4. On first qualifying appearance, record the EXACT earliest timestamp (MM:SS) where she is clearly visible.
5. Timestamp must be the earliest frame of clear visibility (not later recap).
6. Provide a concise BLOCK REASON in description when detected (e.g. "Real woman present" / "Real girl visible"). If not detected, explanation like "No real female person".
7. Keep JSON exactly as specifiedâ€”no extra properties.

OUTPUT JSON (strict, no extra keys):
{"detected": boolean, "timestamp": "MM:SS", "confidence": float, "description": "reason for allow/block"}
If not detected set timestamp to "00:00".
            `;

          onMounted(() => {
            const saved = localStorage.getItem("gemini_api_key");
            if (saved) apiKey.value = saved;
          });

          const saveApiKey = () => {
            if (!apiKey.value) return;
            localStorage.setItem("gemini_api_key", apiKey.value);
            savedMessage.value = "âœ“ × ×©××¨";
            setTimeout(() => (savedMessage.value = ""), 2000);
          };

          const scanVideo = async () => {
            if (!apiKey.value) {
              error.value = "× × ×œ×”×–×™×Ÿ ××¤×ª×— API";
              return;
            }

            loading.value = true;
            error.value = null;
            result.value = null;

            try {
              const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey.value}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contents: [
                      {
                        parts: [
                          {
                            file_data: {
                              mime_type: "video/mp4",
                              file_uri: videoUrl.value,
                            },
                          },
                          { text: PROMPT },
                        ],
                      },
                    ],
                    generationConfig: {
                      response_mime_type: "application/json",
                    },
                  }),
                }
              );

              if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errText}`);
              }

              const data = await response.json();

              // Parse Gemini response
              const candidate = data.candidates?.[0]?.content?.parts?.[0]?.text;
              if (!candidate)
                throw new Error("No content returned from Gemini");

              const parsed = JSON.parse(candidate);

              result.value = {
                allowed: !parsed.detected,
                timestamp: parsed.timestamp || "00:00",
                details: parsed.description,
                confidence: parsed.confidence,
              };
            } catch (e) {
              console.error(e);
              error.value = e.message || "×©×’×™××” ×œ× ×™×“×•×¢×”";
            } finally {
              loading.value = false;
            }
          };

          return {
            apiKey,
            videoUrl,
            loading,
            result,
            error,
            savedMessage,
            saveApiKey,
            scanVideo,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
